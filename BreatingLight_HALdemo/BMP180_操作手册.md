# BMP180 数字气压传感器操作手册

## 📋 目录
- [1. 概述](#1-概述)
- [2. 硬件连接](#2-硬件连接)
- [3. 校准系数表](#3-校准系数表)
- [4. 寄存器映射](#4-寄存器映射)
- [5. API函数说明](#5-api函数说明)
- [6. 使用示例](#6-使用示例)
- [7. 测量流程](#7-测量流程)
- [8. 注意事项](#8-注意事项)
- [9. 故障排除](#9-故障排除)

---

## 1. 概述

### 1.1 产品特性
- **传感器类型**: 数字气压传感器
- **测量范围**: 300-1100 hPa (海拔 +9000m 到 -500m)
- **精度**: ±0.25m (低海拔噪声)
- **接口**: I2C数字接口
- **工作电压**: 1.8V - 3.6V
- **工作温度**: -40°C 到 +85°C

### 1.2 主要功能
- ✅ 气压测量 (300-1100 hPa)
- ✅ 温度测量 (-40°C 到 +85°C)
- ✅ 海拔高度计算
- ✅ 4种过采样模式 (超低功耗到超高精度)
- ✅ 内置校准系数 (EEPROM存储)

---

## 2. 硬件连接

### 2.1 I2C接口连接
```
STM32F401RET6    BMP180
--------------   ------
PB8 (SCL)   -->  SCL
PB9 (SDA)   <->  SDA
3.3V        -->  VCC
GND         -->  GND
```

### 2.2 I2C地址
- **7位地址**: `0x77`
- **8位写地址**: `0xEE` (0x77 << 1)
- **8位读地址**: `0xEF` (0x77 << 1 | 1)

---

## 3. 校准系数表

根据BMP180数据手册，校准系数存储在EEPROM中，地址映射如下：

| 参数 | MSB地址 | LSB地址 | 数据类型 | 说明 |
|------|---------|---------|----------|------|
| AC1  | 0xAA    | 0xAB    | int16_t  | 校准系数1 |
| AC2  | 0xAC    | 0xAD    | int16_t  | 校准系数2 |
| AC3  | 0xAE    | 0xAF    | int16_t  | 校准系数3 |
| AC4  | 0xB0    | 0xB1    | uint16_t | 校准系数4 (无符号) |
| AC5  | 0xB2    | 0xB3    | uint16_t | 校准系数5 (无符号) |
| AC6  | 0xB4    | 0xB5    | uint16_t | 校准系数6 (无符号) |
| B1   | 0xB6    | 0xB7    | int16_t  | 校准系数B1 |
| B2   | 0xB8    | 0xB9    | int16_t  | 校准系数B2 |
| MB   | 0xBA    | 0xBB    | int16_t  | 校准系数MB |
| MC   | 0xBC    | 0xBD    | int16_t  | 校准系数MC |
| MD   | 0xBE    | 0xBF    | int16_t  | 校准系数MD |

### 3.1 校准系数数据结构
```c
typedef struct {
    int16_t AC1;    // 校准系数AC1
    int16_t AC2;    // 校准系数AC2
    int16_t AC3;    // 校准系数AC3
    uint16_t AC4;   // 校准系数AC4 (无符号)
    uint16_t AC5;   // 校准系数AC5 (无符号)
    uint16_t AC6;   // 校准系数AC6 (无符号)
    int16_t B1;     // 校准系数B1
    int16_t B2;     // 校准系数B2
    int16_t MB;     // 校准系数MB
    int16_t MC;     // 校准系数MC
    int16_t MD;     // 校准系数MD
} BMP180_CalibData_t;
```

---

## 4. 寄存器映射

### 4.1 控制寄存器
| 寄存器名称 | 地址 | 功能 |
|------------|------|------|
| CTRL_MEAS  | 0xF4 | 控制测量寄存器 |
| OUT_MSB    | 0xF6 | 输出数据高字节 |
| OUT_LSB    | 0xF7 | 输出数据低字节 |
| OUT_XLSB   | 0xF8 | 输出数据扩展低字节 |

### 4.2 测量命令
| 命令 | 值   | 功能 | 转换时间 |
|------|------|------|----------|
| 温度测量 | 0x2E | 启动温度转换 | 4.5ms |
| 气压测量 OSS=0 | 0x34 | 超低功耗模式 | 4.5ms |
| 气压测量 OSS=1 | 0x74 | 标准模式 | 7.5ms |
| 气压测量 OSS=2 | 0xB4 | 高分辨率模式 | 13.5ms |
| 气压测量 OSS=3 | 0xF4 | 超高分辨率模式 | 25.5ms |

### 4.3 过采样设置 (OSS)
```c
typedef enum {
    BMP180_OSS_ULTRA_LOW_POWER = 0,    // 超低功耗模式 (1次采样)
    BMP180_OSS_STANDARD = 1,           // 标准模式 (2次采样)
    BMP180_OSS_HIGH_RESOLUTION = 2,    // 高分辨率模式 (4次采样)
    BMP180_OSS_ULTRA_HIGH_RES = 3      // 超高分辨率模式 (8次采样)
} BMP180_OSS_t;
```

---

## 5. API函数说明

### 5.1 初始化函数
```c
HAL_StatusTypeDef BMP180_Init(void);
```
- **功能**: 初始化BMP180传感器，读取校准系数
- **返回值**: `HAL_OK` 成功，`HAL_ERROR` 失败
- **说明**: 必须在使用其他函数前调用

### 5.2 数据读取函数
```c
HAL_StatusTypeDef BMP180_GetData(BMP180_Data_t* data, BMP180_OSS_t oss);
```
- **功能**: 获取完整的测量数据（温度、气压、海拔）
- **参数**: 
  - `data`: 数据结构体指针
  - `oss`: 过采样设置
- **返回值**: `HAL_OK` 成功，`HAL_ERROR` 失败

### 5.3 校准系数读取
```c
HAL_StatusTypeDef BMP180_ReadCalibration(BMP180_CalibData_t* calib_data);
```
- **功能**: 读取传感器校准系数
- **参数**: `calib_data` 校准数据结构体指针
- **返回值**: `HAL_OK` 成功，`HAL_ERROR` 失败

### 5.4 原始数据读取
```c
int32_t BMP180_ReadUncompensatedTemperature(void);
int32_t BMP180_ReadUncompensatedPressure(BMP180_OSS_t oss);
```
- **功能**: 读取未补偿的原始温度和气压数据
- **返回值**: 原始数据值

### 5.5 数据计算函数
```c
float BMP180_CalculateTemperature(int32_t ut, BMP180_CalibData_t* calib_data);
float BMP180_CalculatePressure(int32_t up, int32_t ut, BMP180_OSS_t oss, BMP180_CalibData_t* calib_data);
float BMP180_CalculateAltitude(float pressure, float sea_level_pressure);
```
- **功能**: 根据原始数据和校准系数计算真实值

---

## 6. 使用示例

### 6.1 基本使用示例
```c
#include "BMP180.h"

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    
    // 初始化BMP180
    if (BMP180_Init() != HAL_OK) {
        // 初始化失败处理
        while(1);
    }
    
    BMP180_Data_t sensor_data;
    
    while (1) {
        // 读取传感器数据 (高分辨率模式)
        if (BMP180_GetData(&sensor_data, BMP180_OSS_HIGH_RESOLUTION) == HAL_OK) {
            // 数据读取成功
            printf("温度: %.1f°C\n", sensor_data.temperature);
            printf("气压: %.0f Pa\n", sensor_data.pressure);
            printf("海拔: %.1f m\n", sensor_data.altitude);
        }
        
        HAL_Delay(1000);  // 1秒间隔
    }
}
```

### 6.2 不同精度模式对比
```c
void test_different_modes(void)
{
    BMP180_Data_t data;
    
    // 超低功耗模式 (最快，精度最低)
    BMP180_GetData(&data, BMP180_OSS_ULTRA_LOW_POWER);
    printf("超低功耗: %.1f°C, %.0fPa\n", data.temperature, data.pressure);
    
    // 标准模式
    BMP180_GetData(&data, BMP180_OSS_STANDARD);
    printf("标准模式: %.1f°C, %.0fPa\n", data.temperature, data.pressure);
    
    // 高分辨率模式
    BMP180_GetData(&data, BMP180_OSS_HIGH_RESOLUTION);
    printf("高分辨率: %.1f°C, %.0fPa\n", data.temperature, data.pressure);
    
    // 超高分辨率模式 (最慢，精度最高)
    BMP180_GetData(&data, BMP180_OSS_ULTRA_HIGH_RES);
    printf("超高分辨率: %.1f°C, %.0fPa\n", data.temperature, data.pressure);
}
```

### 6.3 海拔高度校准
```c
void altitude_calibration_example(void)
{
    BMP180_Data_t data;
    float sea_level_pressure = 101325.0f;  // 标准海平面气压
    
    // 如果知道当前海拔，可以校准海平面气压
    float current_altitude = 100.0f;  // 当前海拔100米
    
    BMP180_GetData(&data, BMP180_OSS_HIGH_RESOLUTION);
    
    // 根据当前海拔反推海平面气压
    sea_level_pressure = data.pressure / powf(1.0f - (current_altitude / 44330.0f), 5.255f);
    
    // 使用校准后的海平面气压计算精确海拔
    data.altitude = BMP180_CalculateAltitude(data.pressure, sea_level_pressure);
    
    printf("校准后海拔: %.1f m\n", data.altitude);
}
```

---

## 7. 测量流程

### 7.1 温度测量流程
```
1. 写入温度测量命令 (0x2E) 到控制寄存器 (0xF4)
2. 等待转换完成 (4.5ms)
3. 读取温度数据 (0xF6-0xF7)
4. 使用校准系数计算真实温度
```

### 7.2 气压测量流程
```
1. 写入气压测量命令 (0x34/0x74/0xB4/0xF4) 到控制寄存器 (0xF4)
2. 等待转换完成 (4.5ms-25.5ms，取决于OSS设置)
3. 读取气压数据 (0xF6-0xF8)
4. 使用校准系数和温度数据计算真实气压
```

### 7.3 完整测量序列
```
温度测量 → 气压测量 → 数据补偿计算 → 海拔计算
```

---

## 8. 注意事项

### 8.1 硬件注意事项
- ⚠️ **电源电压**: 确保供电电压在1.8V-3.6V范围内
- ⚠️ **I2C上拉**: SCL和SDA线路需要上拉电阻 (通常4.7kΩ)
- ⚠️ **接地**: 确保良好的接地连接
- ⚠️ **EMI防护**: 避免强电磁干扰环境

### 8.2 软件注意事项
- ⚠️ **初始化顺序**: 必须先调用 `BMP180_Init()` 再使用其他函数
- ⚠️ **校准系数**: 校准系数对测量精度至关重要，读取失败会导致错误结果
- ⚠️ **测量间隔**: 连续测量时建议间隔至少100ms
- ⚠️ **温度依赖**: 气压计算需要温度数据，建议每次气压测量前先测量温度

### 8.3 精度与功耗平衡
| 模式 | 转换时间 | 电流消耗 | 精度 | 适用场景 |
|------|----------|----------|------|----------|
| OSS=0 | 4.5ms | 3μA | 低 | 电池供电，快速采样 |
| OSS=1 | 7.5ms | 5μA | 中等 | 一般应用 |
| OSS=2 | 13.5ms | 7μA | 高 | 精确测量 |
| OSS=3 | 25.5ms | 12μA | 最高 | 高精度应用 |

---

## 9. 故障排除

### 9.1 常见问题及解决方案

#### 问题1: 初始化失败
**现象**: `BMP180_Init()` 返回 `HAL_ERROR`
**可能原因**:
- I2C连接问题
- 设备地址错误
- 电源供电问题

**解决方案**:
```c
// 检查I2C连接
uint8_t test_data;
if (BMP180_ReadReg(0xAA, &test_data) != HAL_OK) {
    printf("I2C通信失败\n");
}

// 检查校准系数是否合理
BMP180_CalibData_t calib;
BMP180_ReadCalibration(&calib);
printf("AC1=%d, AC2=%d, AC3=%d\n", calib.AC1, calib.AC2, calib.AC3);
```

#### 问题2: 数据异常
**现象**: 读取的温度或气压数据明显不合理
**可能原因**:
- 校准系数读取错误
- 测量时序问题
- 数据计算错误

**解决方案**:
```c
// 验证校准系数
if (calib.AC1 == 0 || calib.AC1 == -1) {
    printf("校准系数异常\n");
    // 重新读取校准系数
    BMP180_ReadCalibration(&calib);
}

// 检查原始数据
int32_t ut = BMP180_ReadUncompensatedTemperature();
int32_t up = BMP180_ReadUncompensatedPressure(BMP180_OSS_STANDARD);
printf("原始温度: %ld, 原始气压: %ld\n", ut, up);
```

#### 问题3: I2C通信超时
**现象**: I2C读写操作超时
**解决方案**:
- 检查SCL/SDA连接
- 确认上拉电阻存在
- 降低I2C时钟频率
- 检查总线是否被其他设备占用

### 9.2 调试技巧
```c
// 调试宏定义
#define BMP180_DEBUG 1

#if BMP180_DEBUG
#define BMP180_LOG(fmt, ...) printf("[BMP180] " fmt "\n", ##__VA_ARGS__)
#else
#define BMP180_LOG(fmt, ...)
#endif

// 在关键位置添加调试信息
HAL_StatusTypeDef BMP180_Init(void)
{
    BMP180_LOG("开始初始化BMP180...");
    
    MyI2C_Init();
    BMP180_LOG("I2C初始化完成");
    
    if (BMP180_ReadCalibration(&g_calib_data) != HAL_OK) {
        BMP180_LOG("校准系数读取失败");
        return HAL_ERROR;
    }
    
    BMP180_LOG("校准系数: AC1=%d, AC2=%d", g_calib_data.AC1, g_calib_data.AC2);
    BMP180_LOG("BMP180初始化成功");
    
    g_bmp180_initialized = 1;
    return HAL_OK;
}
```

---

## 📚 参考资料

1. **BMP180数据手册**: [Bosch Sensortec官方文档](https://cdn-shop.adafruit.com/datasheets/BST-BMP180-DS000-09.pdf)
2. **I2C协议规范**: I2C-bus specification and user manual
3. **STM32F4 HAL库文档**: STM32F4xx HAL Driver User Manual
4. **应用笔记**: BMP180 Digital pressure sensor Application Note

---

## 📝 版本历史

| 版本 | 日期 | 更新内容 |
|------|------|----------|
| v1.0 | 2024-01 | 初始版本，基本功能实现 |

---

## 📧 技术支持

如有技术问题，请参考：
- 官方数据手册和应用笔记
- STM32社区论坛
- Bosch Sensortec技术支持

---

**© 2024 BMP180操作手册 - 基于STM32F401RET6平台**