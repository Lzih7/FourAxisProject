;==============================================================================
; STM32F103C8 LED控制汇编程序
; 功能：控制PC13引脚的LED闪烁
; 日期：2025
;==============================================================================

;------------------------------------------------------------------------------
; 寄存器地址定义
;------------------------------------------------------------------------------
RCC_APB2ENR         EQU     0x40021018      ; RCC APB2外设时钟使能寄存器
GPIOC_CRH           EQU     0x40011004      ; GPIOC配置寄存器高位(控制引脚8-15)
GPIOC_ODR           EQU     0x4001100C      ; GPIOC输出数据寄存器
Systick_CTRL        EQU     0xE000E010      ; SysTick控制与状态寄存器
Systick_LOAD        EQU     0xE000E014      ; SysTick加载值寄存器
Systick_VAL         EQU     0xE000E018      ; SysTick当前值寄存器

;------------------------------------------------------------------------------
; 位定义
;------------------------------------------------------------------------------
RCC_APB2ENR_IOPCEN  EQU     0x00000010      ; GPIOC时钟使能位(bit 4)
GPIO_CRH_CNF13      EQU     0x00C00000      ; PC13配置位[23:22]
GPIO_CRH_MODE13     EQU     0x00300000      ; PC13模式位[21:20]
GPIO_ODR_ODR13      EQU     0x00002000      ; PC13输出数据位(bit 13)

;==============================================================================
; 代码段定义
;==============================================================================
                AREA    |.text|, CODE, READONLY
                THUMB                           ; 使用Thumb指令集
                REQUIRE8                        ; 要求8字节对齐
                PRESERVE8                       ; 保持8字节对齐

                EXPORT  __main                    ; 导出main函数
                ENTRY                           ; 程序入口点

;==============================================================================
; 主函数 - LED闪烁控制程序
;==============================================================================
__main
                ;--------------------------------------------------------------
                ; 步骤1: 开启GPIOC时钟
                ; RCC->APB2ENR |= RCC_APB2ENR_IOPCEN
                ;--------------------------------------------------------------
                LDR     r0, =RCC_APB2ENR        ; 加载RCC_APB2ENR寄存器地址
                LDR     r1, [r0]                ; 读取当前寄存器值
                LDR     r2, =RCC_APB2ENR_IOPCEN ; 加载GPIOC时钟使能位
                ORR     r1, r1, r2              ; 设置GPIOC时钟使能位
                STR     r1, [r0]                ; 写回寄存器

                ;--------------------------------------------------------------
                ; 步骤2: 配置PC13为推挽输出模式，50MHz
                ; GPIOC->CRH &= ~(GPIO_CRH_CNF13 | GPIO_CRH_MODE13)
                ; GPIOC->CRH |= GPIO_CRH_MODE13 (50MHz输出)
                ;--------------------------------------------------------------
                LDR     r0, =GPIOC_CRH          ; 加载GPIOC_CRH寄存器地址
                LDR     r1, [r0]                ; 读取当前寄存器值
                
                ; 清除PC13的配置位和模式位
                LDR     r2, =GPIO_CRH_CNF13     ; 加载配置位掩码
                LDR     r3, =GPIO_CRH_MODE13    ; 加载模式位掩码
                ORR     r2, r2, r3              ; 合并需要清除的位
                BIC     r1, r1, r2              ; 清除这些位
                
                ; 设置PC13为推挽输出，50MHz (MODE13[1:0] = 11)
                LDR     r2, =GPIO_CRH_MODE13    ; 加载模式位
                ORR     r1, r1, r2              ; 设置模式位为11(50MHz输出)
                STR     r1, [r0]                ; 写回寄存器

;==============================================================================
; 主循环 - LED闪烁控制
;==============================================================================
loop
                ;--------------------------------------------------------------
                ; 点亮LED (设置PC13输出低电平)
                ; GPIOC->ODR &= ~GPIO_ODR_ODR13
                ;--------------------------------------------------------------
                LDR     r0, =GPIOC_ODR          ; 加载GPIOC_ODR寄存器地址
                LDR     r1, [r0]                ; 读取当前寄存器值
                LDR     r2, =GPIO_ODR_ODR13     ; 加载PC13输出位
                BIC     r1, r1, r2              ; 清除PC13位(设置为低电平)
                STR     r1, [r0]                ; 写回寄存器

                LDR     r0, =500000
                BL      delay
                
                ;--------------------------------------------------------------
                ; 熄灭LED (设置PC13输出高电平)
                ; GPIOC->ODR |= GPIO_ODR_ODR13
                ;--------------------------------------------------------------
                LDR     r0, =GPIOC_ODR          ; 加载GPIOC_ODR寄存器地址
                LDR     r1, [r0]                ; 读取当前寄存器值
                LDR     r2, =GPIO_ODR_ODR13     ; 加载PC13输出位
                ORR     r1, r1, r2              ; 设置PC13位(设置为高电平)
                STR     r1, [r0]                ; 写回寄存器

                LDR     r0, =500000
                BL      delay
                B       loop                    ; 无条件跳转到loop标签，形成无限循环

delay
                LSL     r1, r0, #6
                LSL     r2, r0, #3
                ADD     r1, r1, r2              ; r1 = r0 * 72

                LDR     r2, =Systick_LOAD
                STR     r1, [r2]
                
                LDR     r2, =Systick_VAL
                MOV     r1, #0
                STR     r1, [r2]

                LDR     r2, =Systick_CTRL
                MOV     r1, #0x05
                STR     r1, [r2]

delay_loop
                LDR     r1, [r2]
                ANDS    r1, r1, #0x00010000
                BNE     delay_loop

                LDR     r2, =Systick_CTRL
                MOV     r1, #0x04
                STR     r1, [r2]

                BX      lr
;==============================================================================
; 程序结束
;==============================================================================
                ALIGN                           ; 确保代码段对齐
                END