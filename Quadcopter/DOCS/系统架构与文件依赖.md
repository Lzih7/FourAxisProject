# STM32F401RE 四轴飞行器系统架构与文件依赖说明

## 一、项目目录结构

```
Quadcopter/
├── Inc/                    # 应用层头文件
│   ├── main.h
│   ├── stm32f4xx_it.h
│   └── stm32f4xx_hal_conf.h
├── Src/                    # 应用层源文件
│   ├── main.c
│   └── stm32f4xx_it.c
├── MyLib/                  # 自定义外设驱动库
│   ├── BLDC.h/.c          # 无刷电机控制
│   ├── GY86.h/.c          # IMU传感器(MPU6050/HMC5883L/MS5611)
│   ├── OLED.h/.c          # OLED显示
│   ├── MyI2C.h/.c         # 软件I2C
│   ├── Receive_IC.h/.c    # RC接收机输入捕获
│   ├── ReadPeripherals.h/.c
│   ├── PWM_Set.h          # PWM配置宏
│   ├── GPIO_Set.h         # GPIO配置宏
│   └── UART_Set.h         # UART配置
├── Drivers/               # STM32 HAL/CMSIS库(不可修改)
│   ├── CMSIS/
│   │   ├── Device/ST/STM32F4xx/
│   │   │   ├── Include/stm32f401xe.h
│   │   │   ├── Include/system_stm32f4xx.h
│   │   │   └── Source/startup_stm32f401xe.s  # 启动文件(关键)
│   │   │   └── Source/system_stm32f4xx.c    # 系统初始化(关键)
│   │   └── Include/core_cm4.h               # Cortex-M4核心定义
│   └── STM32F4xx_HAL_Driver/
│       └── Inc/ stm32f4xx_hal.h             # HAL库主头文件
└── RTE/                   # 运行时环境
    └── Device/ST/STM32F4xx/
        └── _Sample/     # 链接脚本等
```

## 二、系统文件依赖关系图

```
┌─────────────────────────────────────────────────────────────────────┐
│                        STM32 启动与运行流程                          │
└─────────────────────────────────────────────────────────────────────┘

  硬件复位
    │
    ▼
┌───────────────────────────────────────────────────────────────────┐
│ startup_stm32f401xe.s         (启动文件 - 汇编)                    │
├───────────────────────────────────────────────────────────────────┤
│ 作用:                                                             │
│ 1. 设置初始栈指针(SP)  __initial_sp                               │
│ 2. 设置初始程序指针(PC)  Reset_Handler → __main                    │
│ 3. 中断向量表 (76个中断向量)                                       │
│ 4. 调用 SystemInit() → system_stm32f4xx.c                         │
│ 5. 跳转 __main() → C库初始化 → main()                             │
│                                                                   │
│ 依赖: 无 (最先执行)                                                │
└───────────────────────────────────────────────────────────────────┘
    │
    │ IMPORT SystemInit
    ▼
┌───────────────────────────────────────────────────────────────────┐
│ system_stm32f4xx.c           (系统初始化 - C)                      │
├───────────────────────────────────────────────────────────────────┤
│ 作用:                                                             │
│ 1. SystemInit(): FPU设置, RCC复位, 向量表重定位                    │
│ 2. SystemCoreClockUpdate(): 更新系统时钟频率变量                   │
│                                                                   │
│ 依赖:                                                             │
│  → stm32f4xx.h (设备头文件)                                       │
│  → core_cm4.h (Cortex-M4定义)                                     │
└───────────────────────────────────────────────────────────────────┘
    │
    │ __main() (C库运行时初始化)
    ▼
┌───────────────────────────────────────────────────────────────────┐
│ main.c                     (主程序)                               │
├───────────────────────────────────────────────────────────────────┤
│ int main(void):                                                  │
│   1. HAL_Init()          → stm32f4xx_hal.h                        │
│   2. SystemClock_Config() → 配置84MHz系统时钟                      │
│   3. OLED_Init()         → OLED.h                                 │
│   4. IC_Init()           → Receive_IC.h (TIM输入捕获)              │
│   5. BLDC_Init()         → BLDC.h (TIM3 PWM输出)                  │
│   6. ReadPeripherals_Init() → GY86传感器初始化                     │
│   7. while(1) 主循环                                              │
│                                                                   │
│ 依赖: main.h, GPIO_Set.h, OLED.h, BLDC.h,                         │
│       Receive_IC.h, GY86.h, UART_Set.h, ReadPeripherals.h        │
└───────────────────────────────────────────────────────────────────┘
    │
    ▼
┌───────────────────────────────────────────────────────────────────┐
│ stm32f4xx_it.c              (中断服务程序)                         │
├───────────────────────────────────────────────────────────────────┤
│ SysTick_Handler()  → HAL_IncTick()     (系统滴答)                  │
│ TIM2_IRQHandler()  → HAL_TIM_IRQHandler() (RC接收)                 │
│ TIM4_IRQHandler()  → HAL_TIM_IRQHandler() (传感器定时)              │
│                                                                   │
│ 依赖: stm32f4xx_it.h, stm32f4xx_hal.h                             │
└───────────────────────────────────────────────────────────────────┘
```

## 三、模块依赖关系图

```
                    ┌──────────────────┐
                    │  stm32f4xx_hal.h │ (HAL库主入口)
                    │  stm32f4xx_hal_  │ (外设HAL模块)
                    │  conf.h          │ (HAL配置)
                    └────────┬─────────┘
                             │
              ┌──────────────┼──────────────┐
              ▼              ▼              ▼
    ┌─────────────┐  ┌─────────────┐  ┌─────────────┐
    │  main.h     │  │  GPIO_Set.h │  │  PWM_Set.h  │
    └──────┬──────┘  └─────────────┘  └─────────────┘
           │
      ┌────┴────┬────────┬────────┬────────┐
      ▼         ▼        ▼        ▼        ▼
 ┌─────────┐ ┌──────┐ ┌──────┐ ┌──────┐ ┌──────────┐
 │ main.c  │ │OLED.h│ │BLDC.h│ │Receive│ │  GY86.h  │
 └─────────┘ └───┬──┘ └───┬──┘ │_IC.h │ └─────┬────┘
                 │        │     └───┬──┘       │
                 ▼        ▼         ▼          ▼
           ┌────────────────────────────────────┐
           │         MyI2C.h (软件I2C)          │
           └────────────────────────────────────┘
```

## 四、系统文件详细解析

### 1. startup_stm32f401xe.s (启动文件)

**位置**: `Drivers/CMSIS/Device/ST/STM32F4xx/Source/startup_stm32f401xe.s`

**关键代码**:
```assembly
76:  __Vectors  DCD __initial_sp     ; 栈顶地址
77:             DCD Reset_Handler    ; 复位向量

187: Reset_Handler PROC
189:            IMPORT SystemInit      ; 导入SystemInit函数
190:            IMPORT __main          ; 导入C库入口
192:            LDR R0, =SystemInit
193:            BLX R0                 ; 调用SystemInit
194:            LDR R0, =__main
195:            BX R0                  ; 跳转到C程序
```

**作用**:
- **第一个执行的文件**(硬件复位后)
- 设置栈/堆大小 (Stack_Size = 0x400, Heap_Size = 0x200)
- 初始化中断向量表 (76个中断向量)
- 调用`SystemInit()`配置系统
- 跳转到C库`__main`，最终调用`main()`

**依赖**: 无 (最先执行)

---

### 2. system_stm32f4xx.c (系统初始化)

**位置**: `Drivers/CMSIS/Device/ST/STM32F4xx/Source/system_stm32f4xx.c`

**关键代码**:
```c
168: void SystemInit(void) {
172:     SCB->CPACR |= ((3UL << 10*2)|(3UL << 11*2));  // 使能FPU
176:     RCC->CR |= (uint32_t)0x00000001;              // HSI开启
179:     RCC->CFGR = 0x00000000;                       // 复位CFGR
185:     RCC->PLLCFGR = 0x24003010;                    // 复位PLL
191:     RCC->CIR = 0x00000000;                       // 禁用中断
201:     SCB->VTOR = FLASH_BASE | VECT_TAB_OFFSET;    // 向量表在Flash
}
```

**作用**:
- 启动后由startup文件调用
- 配置浮点运算单元(FPU) - CP10, CP11全访问
- 复位时钟系统(RCC)
- 设置中断向量表位置 (VTOR寄存器)
- **不**配置PLL (由main.c中SystemClock_Config()配置)

**依赖**:
- `stm32f4xx.h` (设备头文件)
- `core_cm4.h` (Cortex-M4定义)

---

### 3. stm32f4xx_hal_conf.h (HAL配置文件)

**位置**: `Inc/stm32f4xx_hal_conf.h`

**关键配置**:
```c
// HAL模块使能 (55-99行)
#define HAL_MODULE_ENABLED
#define HAL_GPIO_MODULE_ENABLED
#define HAL_TIM_MODULE_ENABLED
#define HAL_I2C_MODULE_ENABLED
#define HAL_UART_MODULE_ENABLED
// ... 等等

// 时钟配置 (107-121行)
#define HSE_VALUE    25000000  // 外部晶振频率 (25MHz)
#define HSI_VALUE    16000000  // 内部RC振荡器频率 (16MHz)
#define LSI_VALUE    32000     // 内部低速振荡器
#define LSE_VALUE    32768     // 外部低速晶振

// 系统配置 (159-164行)
#define VDD_VALUE            3300        // 供电电压 3.3V
#define TICK_INT_PRIORITY    0x0F        // SysTick优先级
#define PREFETCH_ENABLE      1           // 指令预取使能
#define INSTRUCTION_CACHE_ENABLE 1       // 指令缓存使能
#define DATA_CACHE_ENABLE    1           // 数据缓存使能
```

**作用**:
- 控制HAL库模块的编译 (通过条件编译)
- 定义硬件相关的时钟参数
- 配置系统参数 (电压、中断优先级等)

**依赖**: 被所有HAL源文件包含

---

### 4. main.h (主头文件)

**位置**: `Inc/main.h`

**内容**:
```c
#ifndef __MAIN_H
#define __MAIN_H

#include "stm32f4xx_hal.h"

void SystemClock_Config(void);
void Error_Handler(void);

#endif
```

**作用**:
- 声明系统级函数 (SystemClock_Config, Error_Handler)
- 包含HAL库主头文件
- 作为应用层的通用头文件

---

### 5. main.c (主程序)

**位置**: `Src/main.c`

**关键代码**:
```c
57: int main(void) {
59:     HAL_Init();                  // HAL库初始化
60:     SystemClock_Config();        // 配置84MHz时钟
61:     OLED_Init();                 // OLED初始化(I2C)
63:     IC_Init();                   // TIM2输入捕获(RC接收)
64:     BLDC_Init();                 // TIM3 PWM输出(电机)
66:     ReadPeripherals_Init();      // GY86传感器初始化
67:     UART1_FULL_INIT(9600);       // UART1初始化
71:     while(1) {
75:         ReadPeripherals_Process();
76:         HAL_Delay(5);
77:     }
}

17: void SystemClock_Config(void) {
23:     __HAL_RCC_PWR_CLK_ENABLE();
24:     __HAL_PWR_VOLTAGESCALING_CONFIG(PWR_REGULATOR_VOLTAGE_SCALE2);
27:     RCC_OscInitStruct.OscillatorType = RCC_OSCILLATORTYPE_HSI;
28:     RCC_OscInitStruct.HSIState = RCC_HSI_ON;
30:     RCC_OscInitStruct.PLL.PLLState = RCC_PLL_ON;
31:     RCC_OscInitStruct.PLL.PLLSource = RCC_PLLSOURCE_HSI;
32:     RCC_OscInitStruct.PLL.PLLM = 8;
33:     RCC_OscInitStruct.PLL.PLLN = 84;
34:     RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;
35:     RCC_OscInitStruct.PLL.PLLQ = 4;
43:     RCC_ClkInitStruct.SYSCLKSource = RCC_SYSCLKSOURCE_PLLCLK;
46:     RCC_ClkInitStruct.AHBCLKDivider = RCC_SYSCLK_DIV1;
47:     RCC_ClkInitStruct.APB1CLKDivider = RCC_HCLK_DIV2;
48:     RCC_ClkInitStruct.APB2CLKDivider = RCC_HCLK_DIV1;
}
```

**作用**:
- 应用程序入口
- 初始化所有外设
- 配置系统时钟 (HSI → PLL → 84MHz)
- 主循环处理传感器和通信

**依赖**:
- `main.h`, `GPIO_Set.h`, `OLED.h`, `BLDC.h`
- `Receive_IC.h`, `GY86.h`, `UART_Set.h`, `ReadPeripherals.h`

---

### 6. stm32f4xx_it.h (中断声明头文件)

**位置**: `Inc/stm32f4xx_it.h`

**内容**:
```c
#ifndef __STM32F4xx_IT_H
#define __STM32F4xx_IT_H

void NMI_Handler(void);
void HardFault_Handler(void);
void MemManage_Handler(void);
void BusFault_Handler(void);
void UsageFault_Handler(void);
void SVC_Handler(void);
void DebugMon_Handler(void);
void PendSV_Handler(void);
void SysTick_Handler(void);

#endif
```

**作用**:
- 声明所有中断处理函数
- 系统中断异常处理 (Fault handlers)
- 用户外设中断处理 (如TIM2, TIM4)

---

### 7. stm32f4xx_it.c (中断服务程序)

**位置**: `Src/stm32f4xx_it.c`

**关键代码**:
```c
12: void SysTick_Handler(void) {
        HAL_IncTick();              // HAL库时间基准
    }

14: extern TIM_HandleTypeDef htim2;
15: void TIM2_IRQHandler(void) {
        HAL_TIM_IRQHandler(&htim2); // RC接收机中断
    }

19: extern TIM_HandleTypeDef htim4;
20: void TIM4_IRQHandler(void) {
        HAL_TIM_IRQHandler(&htim4); // 定时器中断
    }
```

**作用**:
- 处理系统中断
- **SysTick**: 提供HAL库延时基准 (1kHz)
- **TIM2**: 处理RC接收机PWM输入捕获
- **TIM4**: 处理定时任务
- 异常处理 (HardFault, MemManage等)

**依赖**:
- `stm32f4xx_it.h`
- `stm32f4xx_hal.h`

---

### 8. stm32f401xe.h (设备头文件)

**位置**: `Drivers/CMSIS/Device/ST/STM32F4xx/Include/stm32f401xe.h`

**作用**:
- **寄存器映射**: 定义了STM32F401RE所有外设寄存器的结构体和地址映射 (如 `GPIOA`, `TIM2`, `USART1`)
- **中断编号**: 定义了所有IRQn_Type中断编号枚举 (如 `TIM2_IRQn`)
- **位定义**: 提供了所有寄存器位的掩码和偏移宏 (如 `GPIO_MODER_MODER0`)
- 这是开发中最常查阅的文件，它告诉编译器如何访问硬件寄存器。

**依赖**: `core_cm4.h`, `system_stm32f4xx.h`

---

### 9. core_cm4.h (Cortex-M4 核心定义)

**位置**: `Drivers/CMSIS/Include/core_cm4.h`

**作用**:
- **CMSIS标准**: ARM公司提供的Cortex-M4内核通用接口标准
- **内核外设访问**: 定义了SysTick、NVIC(中断控制器)、SCB(系统控制块)、MPU(内存保护单元)等内核外设的寄存器结构
- **内核指令封装**: 提供了特殊汇编指令的C函数封装，如 `__enable_irq()` (开中断), `__WFI()` (等待中断), `__NOP()` (空操作)
- 它是所有基于Cortex-M4芯片(不仅是STM32)都共用的底层文件

**依赖**: 无 (是底层内核文件)

---

### 10. stm32_hal_legacy.h (HAL 遗留兼容层)

**位置**: `Drivers/STM32F4xx_HAL_Driver/Inc/Legacy/stm32_hal_legacy.h`

**作用**:
- **向后兼容**: 随着HAL库版本的更新，某些宏定义或函数名可能发生变化。为了不破坏旧代码，ST在这个文件中保留了旧名称到新名称的映射。
- **别名定义**: 大量的 `#define OLD_NAME NEW_NAME`，确保使用旧版本API编写的代码在新版本库中也能编译通过。
- 通常不需要直接包含或修改它，它会被 `stm32f4xx_hal_def.h` 自动包含。

---

## 五、运行时流程详解

```
上电 → 硬件复位
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ startup_stm32f401xe.s                                       │
│                                                             │
│  1. 设置SP = __initial_sp (栈顶: 0x20000000 + 0x400)        │
│  2. 设置PC = Reset_Handler                                   │
│  3. 调用 SystemInit()                                       │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ system_stm32f4xx.c :: SystemInit()                          │
│                                                             │
│  1. SCB->CPACR |= (3<<10*2)|(3<<11*2)  // 使能FPU          │
│  2. RCC->CR |= 0x00000001              // HSI开启           │
│  3. RCC->CFGR = 0x00000000             // 复位CFGR          │
│  4. RCC->PLLCFGR = 0x24003010          // 复位PLL           │
│  5. SCB->VTOR = FLASH_BASE | 0x00      // 向量表在Flash     │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ C库初始化 (__main)                                          │
│                                                             │
│  1. 初始化.data段 (从Flash复制到RAM)                         │
│  2. 初始化.bss段 (清零)                                      │
│  3. 调用 main()                                             │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ main.c :: main()                                            │
│                                                             │
│  1. HAL_Init()                                              │
│     → 配置SysTick (1ms中断, HAL_IncTick)                    │
│     → 设置NVIC优先级分组                                    │
│                                                             │
│  2. SystemClock_Config()                                    │
│     → 使能HSI (16MHz)                                       │
│     → 配置PLL: HSI/8 * 84 / 2 = 84MHz                       │
│     → AHB = 84MHz, APB1 = 42MHz, APB2 = 84MHz               │
│                                                             │
│  3. OLED_Init()                                             │
│     → 初始化I2C (软件模拟)                                  │
│     → 初始化OLED显示屏                                      │
│                                                             │
│  4. IC_Init()                                               │
│     → 初始化TIM2输入捕获                                    │
│     → 用于RC接收机PWM信号读取                               │
│                                                             │
│  5. BLDC_Init()                                             │
│     → 初始化TIM3 PWM输出                                    │
│     → 配置4个通道控制4个无刷电机                            │
│                                                             │
│  6. ReadPeripherals_Init()                                  │
│     → 初始化GY86传感器                                      │
│     → MPU6050 (加速度计+陀螺仪)                             │
│     → HMC5883L (磁力计)                                     │
│     → MS5611 (气压计)                                       │
│                                                             │
│  7. UART1_FULL_INIT(9600)                                   │
│     → 初始化UART1通信                                       │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 主循环 while(1)                                              │
│                                                             │
│  ReadPeripherals_Process()                                  │
│    → 读取IMU传感器数据                                       │
│    → 数据融合处理                                           │
│                                                             │
│  HAL_Delay(5)                                               │
│    → 使用SysTick实现5ms延时                                 │
└─────────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────────┐
│ 中断处理                                                     │
│                                                             │
│  SysTick_Handler (1kHz)                                     │
│    → HAL_IncTick()  // HAL库时间基准                        │
│                                                             │
│  TIM2_IRQHandler                                            │
│    → RC接收PWM信号捕获                                      │
│    → 解析遥控器指令                                          │
│                                                             │
│  TIM4_IRQHandler                                            │
│    → 定时任务处理                                           │
└─────────────────────────────────────────────────────────────┘
```

---

## 六、核心依赖链总结

### 启动链
```
startup_stm32f401xe.s → SystemInit() → __main() → main()
```

### HAL库依赖链
```
stm32f4xx_hal_conf.h → stm32f4xx_hal.h → stm32f4xx_hal_XXXX.h
```

### 应用层依赖链
```
main.c → main.h → stm32f4xx_hal.h
main.c → OLED.h → MyI2C.h
main.c → BLDC.h → PWM_Set.h → main.h
main.c → GY86.h → MyI2C.h
main.c → Receive_IC.h → main.h
```

### 中断依赖链
```
硬件中断 → stm32f4xx_it.c → HAL_YYYY_IRQHandler() → 回调函数
```

---

## 七、关键文件用途总结表

| 文件 | 类型 | 作用 | 调用者 |
|------|------|------|--------|
| `startup_stm32f401xe.s` | 启动文件 | 配置栈/堆、向量表、调用SystemInit | 硬件(复位后) |
| `system_stm32f4xx.c` | 系统初始化 | FPU配置、RCC复位、向量表定位 | startup文件 |
| `stm32f4xx_hal_conf.h` | HAL配置 | 控制HAL模块编译、定义时钟参数 | 所有HAL源文件 |
| `stm32f4xx_hal.h` | HAL主头文件 | 声明所有HAL函数和结构体 | 所有应用代码 |
| `main.h` | 主头文件 | 声明SystemClock_Config、Error_Handler | main.c |
| `main.c` | 主程序 | 应用入口、外设初始化、主循环 | __main(C库) |
| `stm32f4xx_it.h` | 中断声明 | 声明中断处理函数 | stm32f4xx_it.c |
| `stm32f4xx_it.c` | 中断处理 | 处理系统中断和用户中断 | NVIC(硬件) |

---

## 八、时钟配置说明

### 时钟源
- **HSI**: 内部RC振荡器 (16MHz) - 本项目使用
- **HSE**: 外部晶振 (25MHz) - 未使用
- **LSI**: 内部低速振荡器 (32kHz) - 看门狗使用
- **LSE**: 外部低速晶振 (32.768kHz) - RTC使用

### PLL配置 (SystemClock_Config)
```
输入: HSI = 16MHz
PLL: VCO = (HSI / PLL_M) * PLL_N = (16 / 8) * 84 = 168MHz
输出: SYSCLK = VCO / PLL_P = 168 / 2 = 84MHz

总线时钟:
  AHB  (HCLK)  = 84MHz  (SYSCLK / 1)
  APB1 (PCLK1) = 42MHz  (HCLK / 2) - TIM2, TIM4
  APB2 (PCLK2) = 84MHz  (HCLK / 1) - TIM3
```

---

## 九、内存映射

```
Flash (512KB): 0x08000000 - 0x0807FFFF
  │
  ├─ 向量表 (startup): 0x08000000
  ├─ 代码段 (.text):    0x08000100+
  └─ 常量段 (.rodata)

SRAM (96KB): 0x20000000 - 0x20017FFF
  │
  ├─ 数据段 (.data):     初始化后的全局变量
  ├─ BSS段 (.bss):       零初始化全局变量
  ├─ 堆 (Heap):          0x200字节 (动态分配)
  └─ 栈 (Stack):         0x400字节 (从顶向下生长)
```

---

## 十、中断向量表

| 位置 | 中断向量 | 用途 | 处理函数 |
|------|----------|------|----------|
| -2 | Initial SP | 栈指针 | __initial_sp |
| -1 | Reset | 复位 | Reset_Handler |
| 0-14 | 系统异常 | NMI, HardFault等 | NMI_Handler, HardFault_Handler... |
| 12 | SysTick | 系统滴答 | SysTick_Handler → HAL_IncTick() |
| 28 | TIM2 | RC接收输入捕获 | TIM2_IRQHandler → HAL_TIM_IRQHandler() |
| 30 | TIM4 | 定时器 | TIM4_IRQHandler → HAL_TIM_IRQHandler() |

---

## 十一、常见问题

### Q1: 为什么 SystemInit() 不配置PLL?
A: SystemInit() 只做最基本的硬件初始化，使能FPU，复位时钟。完整的PLL配置在 `SystemClock_Config()` 中完成，这样更灵活，用户可以根据需要修改时钟配置。

### Q2: startup 文件中的 [WEAK] 是什么意思?
A: [WEAK] 表示弱符号，用户可以在自己的代码中重新定义这些函数来覆盖默认实现。例如，如果需要在 SysTick_Handler 中做额外处理，可以在 stm32f4xx_it.c 中重新定义。

### Q3: HAL_Init() 做了什么?
A:
- 初始化HAL库全局变量
- 配置SysTick定时器 (1ms中断)
- 设置NVIC优先级分组
- 调用 `HAL_MspInit()` (用户可重写)

### Q4: SystemCoreClock 变量在哪里更新?
A: 在 `SystemClock_Config()` 中调用 `HAL_RCC_ClockConfig()` 时会自动更新。也可以手动调用 `SystemCoreClockUpdate()` 来更新。

---

## 十二、修改指南

### 修改系统时钟
在 `main.c` 的 `SystemClock_Config()` 中修改PLL参数:
```c
RCC_OscInitStruct.PLL.PLLM = 8;   // 分频系数 M
RCC_OscInitStruct.PLL.PLLN = 84;  // 倍频系数 N
RCC_OscInitStruct.PLL.PLLP = RCC_PLLP_DIV2;  // 分频系数 P
```

### 修改栈/堆大小
在 `startup_stm32f401xe.s` 中修改:
```assembly
Stack_Size      EQU     0x00000400  ; 栈大小
Heap_Size       EQU     0x00000200  ; 堆大小
```

### 添加新的中断处理
1. 在 `stm32f4xx_it.h` 中声明函数
2. 在 `stm32f4xx_it.c` 中实现函数
3. 在对应外设初始化时使能中断

### 添加新的HAL模块
1. 在 `stm32f4xx_hal_conf.h` 中启用模块宏
2. 在项目中添加对应的源文件
3. 在应用代码中包含对应的头文件

---

## 十三、参考资料

- [STM32F401RE 数据手册](https://www.st.com/resource/en/datasheet/stm32f401re.pdf)
- [STM32F4 参考手册 RM0368](https://www.st.com/resource/en/reference_manual/rm0368-stm32f401xb-c-and-stm32f401xd-advanced-armbased-32bit-mcus-stmicroelectronics.pdf)
- [HAL库用户手册 UM1725](https://www.st.com/resource/en/user_manual/um1725-description-of-stm32f4-hal-and-lowlayer-drivers-stmicroelectronics.pdf)
- [Cortex-M4 技术参考手册](https://developer.arm.com/documentation/100851/latest/)

---

**文档版本**: 1.0
**最后更新**: 2026-02-24
**作者**: OpenCode
**项目**: Quadcopter STM32F401RE
